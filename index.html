<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Typing Game - News Edition</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f9f9f9;
    }
    .hidden { display: none; }
    .centered {
      text-align: center;
      margin: 20px;
    }
    input[type="text"] {
      font-size: 24px;
      padding: 10px;
      width: 80%;
      max-width: 800px;
    }
    .feedback span.correct { color: green; }
    .feedback span.incorrect { color: red; }
    .controls button {
      font-size: 18px;
      margin: 5px;
      padding: 10px 20px;
    }
    .score-info {
      color: red;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="home" class="centered">
    <h1>Typing Game - News Edition</h1>
    <p>Select your game mode:</p>
    <div class="controls">
      <button onclick="startGame('questions', 1)">1 Question</button>
      <button onclick="startGame('questions', 10)">10 Questions</button>
      <button onclick="startGame('questions', 30)">30 Questions</button><br>
      <button onclick="startGame('timer', 60)">1 Minute</button>
      <button onclick="startGame('timer', 180)">3 Minutes</button>
      <button onclick="startGame('timer', 300)">5 Minutes</button>
    </div>
    <p class="score-info">
      スコアは（正タイプ数 × 10 − ミスタイプ数 × 5）÷ 入力文字数 で計算されています。<br>
      ※ 小数第1位まで表示
    </p>
  </div>

  <div id="game" class="centered hidden">
    <h2 id="headline"></h2>
    <input type="text" id="input" oninput="checkTyping()" autocomplete="off" />
    <div id="feedback" class="feedback"></div>
    <p id="status"></p>
    <button onclick="nextHeadline()">Next</button>
    <button onclick="goHome()">Home</button>
  </div>

  <div id="result" class="centered hidden">
    <h2>Results</h2>
    <p id="final-score"></p>
    <p id="score-formula" class="score-info"></p>
    <canvas id="scoreChart" width="400" height="200"></canvas>
    <button onclick="goHome()">Home</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const headlines = [
      "Chris Mason Labour still has a big persuasion job ahead",
      "Household energy bills fall but may not go much lower",
      "Is RFK Jrs divisive plan to Make America Healthy Again fearmongering or revolutionary",
      "I had to investigate my own abuse case because the police failed me",
      "Guilty plea expected over US student murders",
      "Royal train to be cut in Palace cost-saving measure",
      "Father and daughter plucked from sea after cruise ship drama",
      "Emma Raducanu beats British teenager Mimi Xu on first day of Wimbledon",
      "Heatwave peak sees parts of UK climb to 33C",
      "Hundreds of kids to be tested for disease in Australia after childcare rape charge"
    ];

    let shuffledHeadlines = [];
    let current = 0;
    let mode = "questions";
    let limit = 10;
    let startTime = 0;
    let timer = null;
    let mistakeCount = 0;
    let charCount = 0;

    function startGame(selectedMode, value) {
      mode = selectedMode;
      limit = value;
      current = 0;
      mistakeCount = 0;
      charCount = 0;
      shuffledHeadlines = [...headlines].sort(() => Math.random() - 0.5);
      document.getElementById("home").classList.add("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      countdown(3);
    }

    function countdown(seconds) {
      if (seconds === 0) {
        document.getElementById("headline").innerText = "";
        if (mode === 'timer') {
          startTime = Date.now();
          timer = setTimeout(() => finishGame(), limit * 1000);
        }
        setTimeout(() => nextHeadline(), 100);
        return;
      }
      document.getElementById("headline").innerText = `Starting in ${seconds}...`;
      setTimeout(() => countdown(seconds - 1), 1000);
    }

    function nextHeadline() {
      if (mode === 'questions' && current >= limit) return finishGame();
      if (mode === 'timer' && Date.now() - startTime >= limit * 1000) return finishGame();
      document.getElementById("input").value = "";
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("headline").innerText = shuffledHeadlines[current % shuffledHeadlines.length];
      document.getElementById("input").focus();
      current++;
      updateStatus();
    }

    function checkTyping() {
      const input = document.getElementById("input").value;
      const target = document.getElementById("headline").innerText;
      let feedbackHTML = "";
      let localMistakes = 0;
      for (let i = 0; i < input.length; i++) {
        const correct = target[i] === input[i];
        const cls = correct ? "correct" : "incorrect";
        feedbackHTML += `<span class="${cls}">${input[i]}</span>`;
        if (!correct) localMistakes++;
      }
      mistakeCount = localMistakes;
      charCount = input.length;
      document.getElementById("feedback").innerHTML = feedbackHTML;
      updateStatus();
    }

    function updateStatus() {
      let text = `Mistakes: ${mistakeCount}`;
      if (mode === 'questions') text += ` | ${current} / ${limit}`;
      if (mode === 'timer') {
        const remaining = Math.max(0, limit - Math.floor((Date.now() - startTime) / 1000));
        text += ` | Time Left: ${remaining}s`;
      }
      document.getElementById("status").innerText = text;
    }

    function finishGame() {
      clearTimeout(timer);
      const correct = charCount - mistakeCount;
      const rawScore = ((correct * 10 - mistakeCount * 5) / charCount);
      const score = Math.max(0, rawScore).toFixed(1);

      document.getElementById("game").classList.add("hidden");
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("final-score").innerText = `Score: ${score}`;
      document.getElementById("score-formula").innerText =
        "スコアは（正タイプ数 × 10 − ミスタイプ数 × 5）÷ 入力文字数 で計算されています。";

      saveScore(score);
      renderChart();
    }

    function saveScore(score) {
      const scores = JSON.parse(localStorage.getItem("typingScores") || "[]");
      scores.push(parseFloat(score));
      localStorage.setItem("typingScores", JSON.stringify(scores));
    }

    function renderChart() {
      const ctx = document.getElementById("scoreChart").getContext("2d");
      const scores = JSON.parse(localStorage.getItem("typingScores") || "[]");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: scores.map((_, i) => i + 1),
          datasets: [{
            label: "Score",
            data: scores,
            borderWidth: 2,
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          scales: {
            x: {
              title: { display: true, text: "Attempt" }
            },
            y: {
              title: { display: true, text: "Score" },
              beginAtZero: true
            }
          }
        }
      });
    }

    function goHome() {
      document.getElementById("game").classList.add("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("home").classList.remove("hidden");
    }
  </script>
</body>
</html>
