<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Typing Game - Keydown Edition</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f0f0f0;
    }
    .hidden { display: none; }
    .centered {
      text-align: center;
      margin: 20px;
    }
    #input-display {
      font-size: 24px;
      min-height: 40px;
    }
    .correct { color: green; }
    .incorrect { color: red; }
    .controls button {
      font-size: 18px;
      margin: 5px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <div id="home" class="centered">
    <h1>Typing Game - News Edition</h1>
    <p>Select your game mode:</p>
    <div class="controls">
      <button onclick="startGame('questions', 1)">1 Question</button>
      <button onclick="startGame('questions', 10)">10 Questions</button>
      <button onclick="startGame('questions', 30)">30 Questions</button><br>
      <button onclick="startGame('timer', 60)">1 Minute</button>
      <button onclick="startGame('timer', 180)">3 Minutes</button>
      <button onclick="startGame('timer', 300)">5 Minutes</button>
    </div>
  </div>

  <div id="game" class="centered hidden" tabindex="0">
    <h2 id="headline"></h2>
    <div id="input-display"></div>
    <p id="status"></p>
    <button onclick="nextHeadline()">Next</button>
    <button onclick="goHome()">Home</button>
  </div>

  <script>
    const headlines = [
      "Chris Mason Labour still has a big persuasion job ahead",
      "Household energy bills fall but may not go much lower",
      "Is RFK Jrs divisive plan to Make America Healthy Again fearmongering or revolutionary",
      "Guilty plea expected over US student murders",
      "Royal train to be cut in Palace cost-saving measure",
      "Father and daughter plucked from sea after cruise ship drama",
      "Emma Raducanu beats British teenager Mimi Xu on first day of Wimbledon"
    ];

    let shuffled = [];
    let current = 0;
    let mode = "questions";
    let limit = 10;
    let startTime = 0;
    let timer = null;
    let mistakeCount = 0;
    let charCount = 0;
    let userInput = "";

    function shuffle(array) {
      return array.map(value => ({ value, sort: Math.random() }))
                  .sort((a, b) => a.sort - b.sort)
                  .map(({ value }) => value);
    }

    function startGame(selectedMode, value) {
      mode = selectedMode;
      limit = value;
      current = 0;
      mistakeCount = 0;
      charCount = 0;
      shuffled = shuffle(headlines);
      document.getElementById("home").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      document.getElementById("game").focus();
      countdown(3);
    }

    function countdown(seconds) {
      if (seconds === 0) {
        if (mode === 'timer') {
          startTime = Date.now();
          timer = setTimeout(() => finishGame(), limit * 1000);
        }
        userInput = "";
        nextHeadline();
        return;
      }
      document.getElementById("headline").innerText = `Starting in ${seconds}...`;
      setTimeout(() => countdown(seconds - 1), 1000);
    }

    function nextHeadline() {
      if (mode === 'questions' && current >= limit) return finishGame();
      if (mode === 'timer' && Date.now() - startTime >= limit * 1000) return finishGame();
      userInput = "";
      updateInputDisplay();
      document.getElementById("headline").innerText = shuffled[current % shuffled.length];
      current++;
      updateStatus();
    }

    function updateInputDisplay() {
      const target = document.getElementById("headline").innerText;
      let html = "";
      for (let i = 0; i < userInput.length; i++) {
        const correct = userInput[i] === target[i];
        const cls = correct ? "correct" : "incorrect";
        html += `<span class="${cls}">${userInput[i]}</span>`;
      }
      document.getElementById("input-display").innerHTML = html;
    }

    function updateStatus() {
      let text = `Mistakes: ${mistakeCount}`;
      if (mode === 'questions') text += ` | ${current} / ${limit}`;
      if (mode === 'timer') {
        const remaining = Math.max(0, limit - Math.floor((Date.now() - startTime) / 1000));
        text += ` | Time Left: ${remaining}s`;
      }
      document.getElementById("status").innerText = text;
    }

    function finishGame() {
      clearTimeout(timer);
      const score = userInput.length - mistakeCount * 2;
      alert(`Finished!\nScore: ${score}\nMistakes: ${mistakeCount}\nCharacters Typed: ${userInput.length}`);
      goHome();
    }

    function goHome() {
      document.getElementById("game").classList.add("hidden");
      document.getElementById("home").classList.remove("hidden");
    }

    // キー入力判定
    document.getElementById("game").addEventListener("keydown", (e) => {
      const key = e.key;

      if (key === "Backspace") {
        if (userInput.length > 0) userInput = userInput.slice(0, -1);
        updateInputDisplay();
        e.preventDefault();
        return;
      }

      if (key === "Enter") {
        nextHeadline();
        return;
      }

      // 1文字のみ対応（ShiftやCapsLock、変換確定前の全角文字はスキップ）
      if (key.length !== 1) return;

      const expected = document.getElementById("headline").innerText[userInput.length] || "";
      userInput += key;
      if (key !== expected) mistakeCount++;
      updateInputDisplay();
      updateStatus();
    });
  </script>
</body>
</html>
