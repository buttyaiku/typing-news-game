<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Typing Game - News Edition</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      background: #f9f9f9;
    }
    .hidden { display: none; }
    .centered {
      text-align: center;
      margin: 20px;
    }
    input[type="text"] {
      font-size: 24px;
      padding: 10px;
      width: 80%;
      max-width: 800px;
    }
    .feedback span.correct { color: green; }
    .feedback span.incorrect { color: red; }
    .controls button {
      font-size: 18px;
      margin: 5px;
      padding: 10px 20px;
    }
    #resultsTable {
      width: 90%;
      max-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #resultsTable th, #resultsTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="home" class="centered">
    <h1>Typing Game - News Edition</h1>
    <p style="color:red;">※半角英字モードでご入力ください</p>
    <p>Select your game mode:</p>
    <div class="controls">
      <button onclick="startGame('questions', 1)">1 Question</button>
      <button onclick="startGame('questions', 10)">10 Questions</button>
      <button onclick="startGame('questions', 30)">30 Questions</button><br>
      <button onclick="startGame('timer', 60)">1 Minute</button>
      <button onclick="startGame('timer', 180)">3 Minutes</button>
      <button onclick="startGame('timer', 300)">5 Minutes</button>
    </div>
    <p id="formula">Score = (Correct characters - Mistakes × 2) / Time (sec)</p>
  </div>

  <div id="game" class="centered hidden">
    <h2 id="headline"></h2>
    <input type="text" id="input">
    <div id="feedback" class="feedback"></div>
    <p id="status"></p>
    <button onclick="submitAnswer()">Next</button>
    <button onclick="goHome()">Home</button>
  </div>

  <div id="results" class="centered hidden">
    <h2>Game Results</h2>
    <p id="summaryStats"></p>
    <p id="finalScore"></p>
    <div id="history"></div>
    <div id="newsResults"></div>
    <button onclick="goHome()">Home</button>
  </div>

  <script>
    const headlines = [
      { text: "Chris Mason Labour still has a big persuasion job ahead", translation: "クリス・メイソン氏：労働党はまだ説得すべき課題が多い", link: "https://www.bbc.co.uk/news/10628494" },
      { text: "Household energy bills fall but may not go much lower", translation: "家庭のエネルギー料金が下がるも、これ以上は下がらないかも", link: "https://www.bbc.co.uk/news/10628494" }
    ];

    let current = 0;
    let mode = "questions";
    let limit = 10;
    let startTime = 0;
    let timer = null;
    let mistakeCount = 0;
    let charCount = 0;
    let usedHeadlines = [];
    let currentTarget = "";

    function startGame(selectedMode, value) {
      mode = selectedMode;
      limit = value;
      current = 0;
      mistakeCount = 0;
      charCount = 0;
      usedHeadlines = [];
      document.getElementById("home").classList.add("hidden");
      document.getElementById("results").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      countdown(3);
    }

    function countdown(seconds) {
      if (seconds === 0) {
        document.getElementById("headline").innerText = "";
        if (mode === 'timer') {
          startTime = Date.now();
          timer = setTimeout(() => finishGame(), limit * 1000);
        } else {
          startTime = Date.now();
        }
        setTimeout(() => nextHeadline(), 50);
        return;
      }
      document.getElementById("headline").innerText = `Starting in ${seconds}...`;
      setTimeout(() => countdown(seconds - 1), 1000);
    }

    function nextHeadline() {
      if (mode === 'questions' && current >= limit) return finishGame();
      if (mode === 'timer' && Date.now() - startTime >= limit * 1000) return finishGame();
      document.getElementById("input").value = "";
      document.getElementById("feedback").innerHTML = "";
      let pool = headlines.filter(h => !usedHeadlines.includes(h));
      if (pool.length === 0) return finishGame();
      let next = pool[Math.floor(Math.random() * pool.length)];
      usedHeadlines.push(next);
      currentTarget = next.text;
      document.getElementById("headline").innerText = currentTarget;
      document.getElementById("input").focus();
      current++;
      updateStatus();
    }

    function submitAnswer() {
      const input = document.getElementById("input").value;
      let feedbackHTML = "";
      let localMistakeCount = 0;
      for (let i = 0; i < currentTarget.length; i++) {
        const inputChar = input[i] || " ";
        const correct = inputChar === currentTarget[i];
        const cls = correct ? "correct" : "incorrect";
        feedbackHTML += `<span class="${cls}">${inputChar}</span>`;
        if (!correct) localMistakeCount++;
      }
      mistakeCount += localMistakeCount;
      charCount += input.length;
      document.getElementById("feedback").innerHTML = feedbackHTML;
      updateStatus();
      nextHeadline();
    }

    function updateStatus() {
      let text = `Mistakes: ${mistakeCount}`;
      if (mode === 'questions') text += ` | ${current} / ${limit}`;
      if (mode === 'timer') {
        const remaining = Math.max(0, limit - Math.floor((Date.now() - startTime) / 1000));
        text += ` | Time Left: ${remaining}s`;
      }
      document.getElementById("status").innerText = text;
    }

    function finishGame() {
      clearTimeout(timer);
      document.getElementById("game").classList.add("hidden");
      document.getElementById("results").classList.remove("hidden");
      const timeSpent = Math.max((Date.now() - startTime) / 1000, 1);
      const score = ((charCount - mistakeCount * 2) / timeSpent).toFixed(1);
      document.getElementById("summaryStats").innerText = `正タイプ数: ${charCount} | ミス数: ${mistakeCount} | 時間: ${timeSpent.toFixed(1)}秒`;
      document.getElementById("finalScore").innerText = `Score: ${score}（(${charCount} - ${mistakeCount}×2) ÷ ${timeSpent.toFixed(1)}）で計算しています）`;
      renderUsedHeadlines();
    }

    function renderUsedHeadlines() {
      const container = document.getElementById("newsResults");
      container.innerHTML = "<h3>出題されたニュース一覧：</h3>";
      usedHeadlines.forEach((item, index) => {
        container.innerHTML += `
          <details>
            <summary>${index + 1}. ${item.text}</summary>
            <p><strong>翻訳：</strong>${item.translation}</p>
            <p><a href="${item.link}" target="_blank">出典を見る</a></p>
          </details>`;
      });
    }

    function goHome() {
      document.getElementById("results").classList.add("hidden");
      document.getElementById("home").classList.remove("hidden");
    }
  </script>
</body>
</html>
