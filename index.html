<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Typing Game - News Edition</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      background: #f9f9f9;
    }
    .hidden { display: none; }
    .centered {
      text-align: center;
      margin: 20px;
    }
    input[type="text"] {
      font-size: 24px;
      padding: 10px;
      width: 80%;
      max-width: 800px;
    }
    .feedback span.correct { color: green; }
    .feedback span.incorrect { color: red; }
    .controls button {
      font-size: 18px;
      margin: 5px;
      padding: 10px 20px;
    }
    #resultsTable {
      width: 90%;
      max-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #resultsTable th, #resultsTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="home" class="centered">
    <h1>Typing Game - News Edition</h1>
    <p style="color:red;">※半角英字モードでご入力ください</p>
    <p>Select your game mode:</p>
    <div class="controls">
      <button onclick="startGame('questions', 1)">1 Question</button>
      <button onclick="startGame('questions', 10)">10 Questions</button>
      <button onclick="startGame('questions', 30)">30 Questions</button><br>
      <button onclick="startGame('timer', 60)">1 Minute</button>
      <button onclick="startGame('timer', 180)">3 Minutes</button>
      <button onclick="startGame('timer', 300)">5 Minutes</button>
    </div>
    <p id="formula">Score = (Correct characters - Mistakes × 2) / Time (sec)</p>
  </div>

  <div id="game" class="centered hidden">
    <h2 id="headline"></h2>
    <input type="text" id="input">
    <div id="feedback" class="feedback"></div>
    <p id="status"></p>
    <button onclick="submitAnswer()">Next</button>
    <button onclick="goHome()">Home</button>
  </div>

  <div id="results" class="centered hidden">
    <h2>Game Results</h2>
    <p id="summaryStats"></p>
    <p id="finalScore"></p>
    <div id="history"></div>
    <div id="newsResults"></div>
    <button onclick="goHome()">Home</button>
  </div>

  <script>
const headlines = [
  "Chris Mason: Labour still has a big persuasion job ahead",
  "Energy bills fall £11 a month but may not stay lower",
  "Chief Rabbi calls vile Jew-hatred at Glastonbury a national shame",
  "US-Israeli backed Gaza aid group must be shut down, say 130 charities",
  "Royal train to be cut in Palace cost-saving measure",
  "Father jumps off Disney cruise ship to save daughter who fell overboard",
  "Boulter and Kartal win on record-breaking day for British players",
  "Hot weather continues in parts of England but temperatures cool elsewhere",
  "Thai prime minister suspended over leaked phone call",
  "US Senate holds marathon vote on Trump's big beautiful bill",
  "Parental leave and pay for new parents to be reviewed",
  "What has been driving the rise in disability benefit claims?",
  "Did BBC's focus on one potential Glastonbury controversy miss another?",
  "The Papers: Chaos on eve of welfare vote and Red-hot Brits",
  "As Squid Game ends, South Koreans return to the reality that inspired it",
  "Trans troops in US military in survival mode as ban on serving kicks in",
  "House prices see biggest monthly fall for over two years",
  "Guilty plea expected over 2022 murders of four Idaho students",
  "Trump global aid cuts risk 14 million deaths in five years, report says",
  "Millions of lovebugs swarm hikers in South Korea",
  "Parents face hurdles vaccinating children, report says",
  "Turkey arrests journalists over alleged cartoon of Prophet Muhammad",
  "Animal cruelty reports rise by a third in a year",
  "Is Zohran Mamdani the Democrat’s new secret weapon?",
  "Music and Politics At Glastonbury",
  "Al-Hilal climb Everest - but worrying signs for Man City",
  "Faith amid the fury - how Lion king Itoje keeps his peace",
  "What's coming up at Wimbledon today?",
  "Putintseva asks umpire to eject spectator over safety fear",
  "Fifa should consider playing World Cup final at 9am",
  "Is it conceivable that Mercedes could drop Russell for Verstappen?"
];

    let current = 0;
    let mode = "questions";
    let limit = 10;
    let startTime = 0;
    let timer = null;
    let mistakeCount = 0;
    let charCount = 0;
    let usedHeadlines = [];
    let currentTarget = "";
    let currentFeedback = "";

    function startGame(selectedMode, value) {
      mode = selectedMode;
      limit = value;
      current = 0;
      mistakeCount = 0;
      charCount = 0;
      usedHeadlines = [];
      document.getElementById("home").classList.add("hidden");
      document.getElementById("results").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      countdown(3);
    }

    function countdown(seconds) {
      if (seconds === 0) {
        document.getElementById("headline").innerText = "";
        if (mode === 'timer') {
          startTime = Date.now();
          timer = setTimeout(() => finishGame(), limit * 1000);
        } else {
          startTime = Date.now();
        }
        setTimeout(() => nextHeadline(), 50);
        return;
      }
      document.getElementById("headline").innerText = `Starting in ${seconds}...`;
      setTimeout(() => countdown(seconds - 1), 1000);
    }

    function nextHeadline() {
      if (mode === 'questions' && current >= limit) return finishGame();
      if (mode === 'timer' && Date.now() - startTime >= limit * 1000) return finishGame();
      document.getElementById("input").value = "";
      document.getElementById("feedback").innerHTML = "";
      let pool = headlines.filter(h => !usedHeadlines.includes(h));
      if (pool.length === 0) return finishGame();
      let next = pool[Math.floor(Math.random() * pool.length)];
      usedHeadlines.push(next);
      currentTarget = next.text;
      document.getElementById("headline").innerText = currentTarget;
      document.getElementById("input").focus();
      current++;
      updateStatus();
    }

    function submitAnswer() {
      const input = document.getElementById("input").value;
      let feedbackHTML = "";
      let localMistakeCount = 0;
      for (let i = 0; i < currentTarget.length; i++) {
        const inputChar = input[i] || " ";
        const correct = inputChar === currentTarget[i];
        const cls = correct ? "correct" : "incorrect";
        feedbackHTML += `<span class="${cls}">${inputChar}</span>`;
        if (!correct) localMistakeCount++;
      }
      mistakeCount += localMistakeCount;
      charCount += input.length;
      document.getElementById("feedback").innerHTML = feedbackHTML;
      currentFeedback = feedbackHTML;
      updateStatus();
      setTimeout(() => nextHeadline(), 100);
    }

    function updateStatus() {
      let text = `Mistakes: ${mistakeCount}`;
      if (mode === 'questions') text += ` | ${current} / ${limit}`;
      if (mode === 'timer') {
        const remaining = Math.max(0, limit - Math.floor((Date.now() - startTime) / 1000));
        text += ` | Time Left: ${remaining}s`;
      }
      document.getElementById("status").innerText = text;
    }

    function finishGame() {
      clearTimeout(timer);
      document.getElementById("game").classList.add("hidden");
      document.getElementById("results").classList.remove("hidden");
      const timeSpent = Math.max((Date.now() - startTime) / 1000, 1);
      const score = ((charCount - mistakeCount * 2) / timeSpent).toFixed(1);
      document.getElementById("summaryStats").innerText = `正タイプ数: ${charCount} | ミス数: ${mistakeCount} | 時間: ${timeSpent.toFixed(1)}秒`;
      document.getElementById("finalScore").innerText = `Score: ${score}（(${charCount} - ${mistakeCount}×2) ÷ ${timeSpent.toFixed(1)}）で計算しています）`;
      renderUsedHeadlines();
    }

    function renderUsedHeadlines() {
      const container = document.getElementById("newsResults");
      container.innerHTML = "<h3>出題されたニュース一覧：</h3>";
      usedHeadlines.forEach((item, index) => {
        container.innerHTML += `
          <details>
            <summary>${index + 1}. ${item.text}</summary>
            <p><strong>翻訳：</strong>${item.translation}</p>
            <p><a href="${item.link}" target="_blank">出典を見る</a></p>
          </details>`;
      });
    }

    function goHome() {
      document.getElementById("results").classList.add("hidden");
      document.getElementById("home").classList.remove("hidden");
    }
  </script>
</body>
</html>
